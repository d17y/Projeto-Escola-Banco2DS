<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verificação Facial - Futurista</title>
  <style>
    :root {
      --cor-primaria: #00ffff;
      --cor-secundaria: #0077ff;
      --cor-fundo: #02040a;
      --cor-brilho: #0ff;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: 'Orbitron', sans-serif;
      background: radial-gradient(circle at top left, #001020, #000000 70%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes fundo-pulso {
      0% { background: radial-gradient(circle at top left, #001020, #000000 70%); }
      100% { background: radial-gradient(circle at bottom right, #001830, #000000 70%); }
    }

    body {
      animation: fundo-pulso 6s infinite alternate;
    }

    .card {
      width: 90%;
      max-width: 780px;
      background: rgba(0, 10, 20, 0.8);
      border: 2px solid rgba(0, 255, 255, 0.25);
      box-shadow: 0 0 25px rgba(0, 255, 255, 0.25);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      backdrop-filter: blur(8px);
      transition: 0.4s;
    }

    .card:hover {
      box-shadow: 0 0 45px rgba(0, 255, 255, 0.45);
      border-color: rgba(0, 255, 255, 0.4);
      transform: scale(1.02);
    }

    h2 {
      font-size: 1.8em;
      color: var(--cor-primaria);
      text-shadow: 0 0 10px var(--cor-brilho);
      letter-spacing: 2px;
      margin-bottom: 10px;
    }

    p {
      font-size: 0.9em;
      color: #aeeaff;
    }

    video, canvas {
      border-radius: 10px;
      background: #050c16;
      width: 100%;
      max-width: 320px;
      height: auto;
      border: 1px solid rgba(0, 255, 255, 0.3);
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      margin-top: 20px;
    }

    .col {
      flex: 1 1 240px;
      min-width: 240px;
      max-width: 320px;
    }

    button {
      padding: 12px 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
      transition: all 0.3s;
      letter-spacing: 1px;
    }

    .btn-primary {
      background: linear-gradient(90deg, var(--cor-secundaria), var(--cor-primaria));
      color: #000;
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.5);
    }

    .btn-primary:hover {
      box-shadow: 0 0 24px rgba(0, 255, 255, 0.8);
      transform: scale(1.05);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--cor-primaria);
      color: var(--cor-primaria);
    }

    .btn-ghost:hover {
      background: rgba(0, 255, 255, 0.1);
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.3);
    }

    .msg {
      margin-top: 20px;
      min-height: 24px;
      font-weight: 600;
      text-shadow: 0 0 8px rgba(0, 255, 255, 0.3);
      color: var(--cor-primaria);
      letter-spacing: 1px;
    }

  </style>
</head>
<body>
  <div class="card">
    <h2>Verificação Facial</h2>
    <p>Ative a câmera, capture seu rosto e valide sua identidade. Sistema de verificação prototípico de segurança avançada.</p>

    <div class="row">
      <div class="col">
        <label>Vídeo da câmera</label>
        <video id="video" autoplay playsinline></video>
        <small>Permita acesso à câmera.</small>
      </div>

      <div class="col">
        <label>Foto capturada</label>
        <canvas id="preview"></canvas>
        <small>Visualização da imagem atual.</small>
      </div>
    </div>

    <div class="row" style="margin-top:16px">
      <button id="btnStart" class="btn-primary">Abrir câmera</button>
      <button id="btnCapture" class="btn-primary">Capturar</button>
      <button id="btnRegister" class="btn-ghost">Registrar rosto</button>
      <button id="btnVerify" class="btn-primary">Verificar</button>
      <button id="btnClear" class="btn-ghost">Limpar</button>
    </div>

    <div class="msg" id="msg">Referência: <span id="refStatus">nenhuma</span></div>
    <small>⚠️ Este é um protótipo local. Em produção, use um serviço de verificação facial profissional.</small>
  </div>

  <script>
    const video = document.getElementById("video");
    const preview = document.getElementById("preview");
    const ctx = preview.getContext("2d");
    const btnStart = document.getElementById("btnStart");
    const btnCapture = document.getElementById("btnCapture");
    const btnRegister = document.getElementById("btnRegister");
    const btnVerify = document.getElementById("btnVerify");
    const btnClear = document.getElementById("btnClear");
    const msg = document.getElementById("msg");
    const refStatus = document.getElementById("refStatus");
    let stream = null;

  
    const THRESHOLD = 5000; // valor fixo no máximo

    function updateRefStatus() {
      const e = localStorage.getItem(REF_KEY);
      refStatus.innerText = e ? "salva" : "nenhuma";
    }

    function showMessage(text, bg="transparent") {
      msg.innerText = text;
      msg.style.background = bg;
      msg.style.color = "#fff";
    }

    updateRefStatus();

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:false});
        video.srcObject = stream;
        showMessage("Câmera ativada. Posicione seu rosto e clique em 'Capturar'.","rgba(0,128,0,0.08)");
      } catch(e) {
        console.error(e);
        showMessage("Erro ao abrir a câmera: "+(e.message||e),"rgba(255,80,80,0.2)");
      }
    }

    function captureToCanvas() {
      if(!stream) {
        showMessage('Câmera não está ativa. Clique em "Abrir câmera".',"rgba(255,140,0,0.15)");
        return null;
      }
      ctx.drawImage(video,0,0,preview.width,preview.height);
      showMessage("Foto capturada.");
      return preview.toDataURL("image/png");
    }

    function imageDataToSmallGray(dataUrl) {
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload = ()=>{
          const canvas = document.createElement("canvas");
          canvas.width = SMALL_W;
          canvas.height = SMALL_H;
          const context = canvas.getContext("2d");
          context.drawImage(img,0,0,SMALL_W,SMALL_H);
          const imgData = context.getImageData(0,0,SMALL_W,SMALL_H).data;
          const gray = new Float32Array(SMALL_W*SMALL_H);
          for(let i=0,j=0;i<imgData.length;i+=4,j++){gray[j]=0.299*imgData[i]+0.587*imgData[i+1]+0.114*imgData[i+2];}
          resolve(gray);
        };
        img.onerror = reject;
        img.src = dataUrl;
      });
    }

    function mse(a,b){let sum=0;for(let i=0;i<a.length;i++){let diff=a[i]-b[i];sum+=diff*diff;}return sum/a.length;}

    async function registerReference(){
      const dataUrl=captureToCanvas();if(!dataUrl)return;
      showMessage("Processando referência...","rgba(0,128,0,0.06)");
      try{
        const gray=await imageDataToSmallGray(dataUrl);
        localStorage.setItem(REF_KEY,JSON.stringify({visual:dataUrl,gray:Array.from(gray),created:Date.now()}));
        updateRefStatus();
        showMessage("Referência salva com sucesso.","rgba(0,128,0,0.12)");
      }catch(e){console.error(e);showMessage("Erro ao processar referência.","rgba(255,80,80,0.2)");}
    }

    async function verifyFace(){
      const stored=localStorage.getItem(REF_KEY);
      if(!stored){showMessage("Nenhuma referência salva. Registre um rosto primeiro.","rgba(255,140,0,0.15)");return;}
      const ref=JSON.parse(stored);
      const current=captureToCanvas();
      if(!current)return;
      showMessage("Comparando...","rgba(0,128,0,0.04)");
      try{
        const [refGray,curGray]=await Promise.all([Promise.resolve(new Float32Array(ref.gray)),imageDataToSmallGray(current)]);
        const distance=mse(refGray,curGray);
        showMessage("Distância (MSE): "+Math.round(distance));
        if(distance<=THRESHOLD){
          showMessage("✅ Face verificada! Redirecionando...","rgba(0,128,0,0.15)");
          stream && stream.getTracks().forEach(e=>e.stop());
          setTimeout(()=>{window.location.href="index3.html"},1000);
        }else{
          showMessage("❌ Face não corresponde. Tente novamente.","rgba(255,0,0,0.2)");
        }
      }catch(e){console.error(e);showMessage("Erro na verificação.","rgba(255,80,80,0.2)");}
    }

    function clearReference(){localStorage.removeItem(REF_KEY);updateRefStatus();showMessage("Referência removida.");}

    btnStart.addEventListener("click",startCamera);
    btnCapture.addEventListener("click",captureToCanvas);
    btnRegister.addEventListener("click",registerReference);
    btnVerify.addEventListener("click",verifyFace);
    btnClear.addEventListener("click",clearReference);

    window.addEventListener("beforeunload",()=>{stream && stream.getTracks().forEach(e=>e.stop());});
  </script>
</body>
</html>
